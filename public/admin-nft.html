<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Console Admin NFT - S.H.A.C.K.E.R.</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #111827;
            color: #f3f4f6;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .card {
            background-color: #1f2937;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .tab-button {
            background-color: #374151;
            color: #9ca3af;
            padding: 0.75rem 1rem;
            border-radius: 0.25rem 0.25rem 0 0;
            cursor: pointer;
        }
        .tab-button.active {
            background-color: #1f2937;
            color: #f3f4f6;
            border-bottom: 2px solid #8b5cf6;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .form-input {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #f3f4f6;
            padding: 0.5rem;
            border-radius: 0.25rem;
            width: 100%;
            margin-bottom: 1rem;
        }
        .form-textarea {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #f3f4f6;
            padding: 0.5rem;
            border-radius: 0.25rem;
            width: 100%;
            margin-bottom: 1rem;
            min-height: 100px;
        }
        .button-primary {
            background-color: #8b5cf6;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            cursor: pointer;
            border: none;
        }
        .button-primary:hover {
            background-color: #7c3aed;
        }
        .button-secondary {
            background-color: #4b5563;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            cursor: pointer;
            border: none;
        }
        .button-secondary:hover {
            background-color: #6b7280;
        }
        .alert {
            padding: 0.75rem 1rem;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
        }
        .alert-success {
            background-color: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.4);
            color: #10b981;
        }
        .alert-error {
            background-color: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #ef4444;
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .status-active {
            background-color: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        .status-inactive {
            background-color: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <nav class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold text-purple-400">S.H.A.C.K.E.R. Admin</h1>
                <p class="text-gray-400">Contrôlez vos NFTs même après leur vente</p>
            </div>
            <div>
                <a href="/" class="button-secondary mr-2">Retour au NFT</a>
                <button id="connect-wallet" class="button-primary">Connecter wallet</button>
                <div id="wallet-info" class="hidden mt-2 text-right">
                    <p class="text-sm text-gray-400">Connecté: <span id="wallet-address" class="text-white font-mono">...</span></p>
                </div>
            </div>
        </nav>
        
        <div class="flex mb-4 border-b border-gray-700">
            <div class="tab-button active" data-tab="mint">Mint NFT</div>
            <div class="tab-button" data-tab="transfer">Transfert</div>
            <div class="tab-button" data-tab="metadata">Métadonnées</div>
            <div class="tab-button" data-tab="events">Événements</div>
        </div>
        
        <div class="tab-content active" id="mint-tab">
            <div class="card p-6">
                <h2 class="text-xl font-semibold mb-4 text-purple-400">Minter un nouveau NFT</h2>
                
                <div id="mint-message" class="hidden alert"></div>
                
                <form id="mint-form">
                    <div class="mb-4">
                        <label class="block text-gray-400 mb-2">Adresse du contrat</label>
                        <input type="text" id="mint-contract-address" class="form-input" value="0xd10AC868cFC5Ab7B5d3eA041D552FB57F6a03037" readonly>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-400 mb-2">Réseau</label>
                        <select id="mint-network" class="form-input">
                            <option value="sepolia">Sepolia Testnet</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="button-primary w-full">Minter le NFT</button>
                </form>
            </div>
        </div>
        
        <div class="tab-content" id="transfer-tab">
            <div class="card p-6">
                <h2 class="text-xl font-semibold mb-4 text-purple-400">Transférer un NFT</h2>
                
                <div id="transfer-message" class="hidden alert"></div>
                
                <form id="transfer-form">
                    <div class="mb-4">
                        <label class="block text-gray-400 mb-2">Adresse du contrat</label>
                        <input type="text" id="transfer-contract-address" class="form-input" value="0xd10AC868cFC5Ab7B5d3eA041D552FB57F6a03037">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-400 mb-2">ID du token</label>
                        <input type="number" id="transfer-token-id" class="form-input" placeholder="0" min="0">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-400 mb-2">Adresse du destinataire</label>
                        <input type="text" id="transfer-recipient" class="form-input" placeholder="0x...">
                    </div>
                    
                    <button type="submit" class="button-primary w-full">Transférer le NFT</button>
                </form>
            </div>
        </div>
        
        <div class="tab-content" id="metadata-tab">
            <div class="card p-6">
                <h2 class="text-xl font-semibold mb-4 text-purple-400">Mettre à jour les métadonnées</h2>
                
                <div id="metadata-message" class="hidden alert"></div>
                
                <form id="metadata-form">
                    <div class="mb-4">
                        <label class="block text-gray-400 mb-2">ID du token</label>
                        <input type="number" id="metadata-token-id" class="form-input" placeholder="0" min="0">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-400 mb-2">Nom</label>
                        <input type="text" id="metadata-name" class="form-input" placeholder="S.H.A.C.K.E.R. #01">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-400 mb-2">Description</label>
                        <textarea id="metadata-description" class="form-textarea" placeholder="Description du NFT..."></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-400 mb-2">URL de l'image</label>
                        <input type="text" id="metadata-image" class="form-input" placeholder="https://...">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-400 mb-2">Attributs (format JSON)</label>
                        <textarea id="metadata-attributes" class="form-textarea" placeholder='[{"trait_type": "Type", "value": "Demon"}, ...]'></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="flex items-center text-gray-400">
                            <input type="checkbox" id="metadata-auto-update" class="mr-2">
                            Activer les mises à jour automatiques
                        </label>
                    </div>
                    
                    <div id="auto-update-settings" class="mb-4 pl-4 border-l-2 border-gray-700 hidden">
                        <label class="block text-gray-400 mb-2">Intervalle (minutes)</label>
                        <input type="number" id="metadata-interval" class="form-input" value="5" min="1">
                    </div>
                    
                    <button type="submit" class="button-primary w-full">Mettre à jour les métadonnées</button>
                </form>
            </div>
        </div>
        
        <div class="tab-content" id="events-tab">
            <div class="card p-6">
                <h2 class="text-xl font-semibold mb-4 text-purple-400">Gérer les événements en direct</h2>
                
                <div id="events-message" class="hidden alert"></div>
                
                <form id="events-form">
                    <div class="mb-4">
                        <label class="block text-gray-400 mb-2">ID du token</label>
                        <input type="number" id="events-token-id" class="form-input" placeholder="0" min="0">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-400 mb-2">Type d'événement</label>
                        <select id="events-type" class="form-input">
                            <option value="game_bonus">Bonus de jeu</option>
                            <option value="special_achievement">Succès spécial</option>
                            <option value="story_progression">Progression d'histoire</option>
                            <option value="visual_effect">Effet visuel</option>
                            <option value="secret_code">Code secret</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-400 mb-2">Titre de l'événement</label>
                        <input type="text" id="events-title" class="form-input" placeholder="Titre...">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-400 mb-2">Description</label>
                        <textarea id="events-description" class="form-textarea" placeholder="Description de l'événement..."></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-400 mb-2">Durée (minutes)</label>
                        <input type="number" id="events-duration" class="form-input" value="60" min="1">
                    </div>
                    
                    <div id="secret-code-field" class="mb-4 hidden">
                        <label class="block text-gray-400 mb-2">Code secret</label>
                        <input type="text" id="events-secret-code" class="form-input" placeholder="Code...">
                    </div>
                    
                    <button type="submit" class="button-primary w-full">Envoyer l'événement</button>
                </form>
                
                <div class="mt-8">
                    <h3 class="text-lg font-medium mb-4 text-gray-300">Historique des événements</h3>
                    <div id="events-history" class="space-y-4">
                        <p class="text-gray-400 text-center">Aucun événement récent</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // Vérifiez que ethers a bien été chargé
        window.addEventListener('DOMContentLoaded', () => {
            if (typeof ethers === 'undefined') {
                console.error("Ethers.js n'a pas été chargé correctement !");
                showMessage('mint-message', "Erreur: La bibliothèque blockchain (ethers.js) n'a pas été chargée correctement. Veuillez rafraîchir la page ou ouvrir dans un nouvel onglet.", 'error');
            } else {
                console.log("Ethers.js chargé avec succès, version:", ethers.version);
            }
        });

        // Configuration
        const contractAddress = "0xd10AC868cFC5Ab7B5d3eA041D552FB57F6a03037";
        const contractABI = [
            "function mint() public",
            "function transferFrom(address from, address to, uint256 tokenId) public",
            "function ownerOf(uint256 tokenId) public view returns (address)"
        ];
        
        // Variables globales
        let provider;
        let signer;
        let contract;
        let walletAddress;
        
        // Gestion des onglets
        document.querySelectorAll('.tab-button').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
            });
        });
        
        // Fonction pour afficher un message
        function showMessage(elementId, message, type) {
            const messageElement = document.getElementById(elementId);
            if (!messageElement) {
                console.error(`Élément #${elementId} introuvable!`);
                return;
            }
            messageElement.textContent = message;
            messageElement.classList.remove('hidden', 'alert-success', 'alert-error');
            messageElement.classList.add(`alert-${type}`);
        }

        // Connexion du wallet
        document.getElementById('connect-wallet').addEventListener('click', async () => {
            showMessage('mint-message', 'Tentative de connexion à MetaMask...', 'success');
            
            try {
                // Vérifier si ethers est disponible
                if (typeof ethers === 'undefined') {
                    throw new Error("La bibliothèque ethers.js n'est pas disponible. Veuillez rafraîchir la page.");
                }

                // Vérifier si MetaMask est installé
                if (!window.ethereum) {
                    throw new Error("MetaMask n'est pas installé. Veuillez l'installer pour continuer.");
                }
                
                console.log("Connexion à MetaMask...");
                provider = new ethers.providers.Web3Provider(window.ethereum);
                
                // Demander la connexion du wallet
                console.log("Demande d'accès au compte...");
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                console.log("Récupération du signer...");
                signer = provider.getSigner();
                
                console.log("Récupération de l'adresse...");
                walletAddress = await signer.getAddress();
                
                // Afficher l'adresse du wallet
                document.getElementById('wallet-address').textContent = 
                    `${walletAddress.substring(0, 6)}...${walletAddress.substring(walletAddress.length - 4)}`;
                document.getElementById('wallet-info').classList.remove('hidden');
                
                // Créer l'instance du contrat
                console.log("Création de l'instance du contrat...");
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                
                // Vérifier le réseau
                console.log("Vérification du réseau...");
                const network = await provider.getNetwork();
                console.log("Réseau détecté:", network.name, "chainId:", network.chainId);
                
                if (network.chainId !== 11155111) { // Sepolia
                    showMessage('mint-message', 'Attention: Veuillez vous connecter au réseau Sepolia testnet pour interagir avec ce contrat', 'error');
                } else {
                    showMessage('mint-message', 'Connexion réussie à MetaMask sur le réseau Sepolia', 'success');
                }
            } catch (error) {
                console.error('Erreur de connexion:', error);
                showMessage('mint-message', `Erreur de connexion: ${error.message}`, 'error');
            }
        });
        
        // Traitement du formulaire de mint
        document.getElementById('mint-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!contract) {
                showMessage('mint-message', 'Veuillez d\'abord connecter votre wallet', 'error');
                return;
            }
            
            try {
                showMessage('mint-message', 'Transaction en cours...', 'success');
                
                // Appeler la fonction mint du contrat
                const tx = await contract.mint();
                
                showMessage('mint-message', 'Transaction envoyée. En attente de confirmation...', 'success');
                
                // Attendre la confirmation
                const receipt = await tx.wait();
                
                showMessage('mint-message', `NFT minté avec succès ! Hash de transaction: ${receipt.transactionHash}`, 'success');
            } catch (error) {
                console.error('Erreur de mint:', error);
                showMessage('mint-message', `Erreur: ${error.message}`, 'error');
            }
        });
        
        // Traitement du formulaire de transfert
        document.getElementById('transfer-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!contract) {
                showMessage('transfer-message', 'Veuillez d\'abord connecter votre wallet', 'error');
                return;
            }
            
            const tokenId = document.getElementById('transfer-token-id').value;
            const recipient = document.getElementById('transfer-recipient').value;
            
            if (!tokenId || !recipient) {
                showMessage('transfer-message', 'Veuillez remplir tous les champs', 'error');
                return;
            }
            
            try {
                showMessage('transfer-message', 'Vérification de la propriété...', 'success');
                
                // Vérifier que l'utilisateur est bien le propriétaire
                const owner = await contract.ownerOf(tokenId);
                
                if (owner.toLowerCase() !== walletAddress.toLowerCase()) {
                    showMessage('transfer-message', 'Vous n\'êtes pas le propriétaire de ce NFT', 'error');
                    return;
                }
                
                showMessage('transfer-message', 'Transaction en cours...', 'success');
                
                // Effectuer le transfert
                const tx = await contract.transferFrom(walletAddress, recipient, tokenId);
                
                showMessage('transfer-message', 'Transaction envoyée. En attente de confirmation...', 'success');
                
                // Attendre la confirmation
                const receipt = await tx.wait();
                
                showMessage('transfer-message', `NFT transféré avec succès ! Hash de transaction: ${receipt.transactionHash}`, 'success');
            } catch (error) {
                console.error('Erreur de transfert:', error);
                showMessage('transfer-message', `Erreur: ${error.message}`, 'error');
            }
        });
        
        // Traitement du formulaire de métadonnées
        document.getElementById('metadata-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!walletAddress) {
                showMessage('metadata-message', 'Veuillez d\'abord connecter votre wallet', 'error');
                return;
            }
            
            const tokenId = document.getElementById('metadata-token-id').value;
            const name = document.getElementById('metadata-name').value;
            const description = document.getElementById('metadata-description').value;
            const image = document.getElementById('metadata-image').value;
            const attributesText = document.getElementById('metadata-attributes').value;
            const autoUpdate = document.getElementById('metadata-auto-update').checked;
            const updateInterval = document.getElementById('metadata-interval').value;
            
            if (!tokenId) {
                showMessage('metadata-message', 'Veuillez spécifier un ID de token', 'error');
                return;
            }
            
            let attributes = [];
            if (attributesText) {
                try {
                    attributes = JSON.parse(attributesText);
                } catch (error) {
                    showMessage('metadata-message', 'Les attributs doivent être au format JSON valide', 'error');
                    return;
                }
            }
            
            const metadata = {
                name,
                description,
                image,
                attributes
            };
            
            if (autoUpdate) {
                metadata.updateFrequency = parseInt(updateInterval);
            }
            
            try {
                showMessage('metadata-message', 'Mise à jour des métadonnées en cours...', 'success');
                
                // Envoyer la mise à jour des métadonnées au serveur
                const response = await fetch(`/api/metadata/${tokenId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ownerAddress: walletAddress,
                        metadata
                    }),
                });
                
                if (!response.ok) {
                    throw new Error(`Erreur serveur: ${response.status}`);
                }
                
                const result = await response.json();
                
                showMessage('metadata-message', 'Métadonnées mises à jour avec succès', 'success');
            } catch (error) {
                console.error('Erreur de mise à jour des métadonnées:', error);
                showMessage('metadata-message', `Erreur: ${error.message}`, 'error');
            }
        });
        
        // Traitement du formulaire d'événements
        document.getElementById('events-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!walletAddress) {
                showMessage('events-message', 'Veuillez d\'abord connecter votre wallet', 'error');
                return;
            }
            
            const tokenId = document.getElementById('events-token-id').value;
            const eventType = document.getElementById('events-type').value;
            const title = document.getElementById('events-title').value;
            const description = document.getElementById('events-description').value;
            const duration = document.getElementById('events-duration').value;
            const secretCode = document.getElementById('events-secret-code').value;
            
            if (!tokenId || !title) {
                showMessage('events-message', 'Veuillez spécifier un ID de token et un titre', 'error');
                return;
            }
            
            const eventData = {
                type: eventType,
                title,
                description,
                duration: parseInt(duration),
                startTime: new Date().toISOString()
            };
            
            if (eventType === 'secret_code' && secretCode) {
                eventData.secretCode = secretCode;
            }
            
            try {
                showMessage('events-message', 'Envoi de l\'événement en cours...', 'success');
                
                // Envoyer l'événement au serveur
                const response = await fetch(`/api/events/${tokenId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ownerAddress: walletAddress,
                        eventData
                    }),
                });
                
                if (!response.ok) {
                    throw new Error(`Erreur serveur: ${response.status}`);
                }
                
                const result = await response.json();
                
                showMessage('events-message', 'Événement envoyé avec succès', 'success');
                
                // Ajouter l'événement à l'historique
                addEventToHistory(eventType, title, description);
                
                // Réinitialiser le formulaire
                document.getElementById('events-title').value = '';
                document.getElementById('events-description').value = '';
                document.getElementById('events-secret-code').value = '';
            } catch (error) {
                console.error('Erreur d\'envoi d\'événement:', error);
                showMessage('events-message', `Erreur: ${error.message}`, 'error');
            }
        });
        
        // Afficher/masquer les paramètres de mise à jour automatique
        document.getElementById('metadata-auto-update').addEventListener('change', (e) => {
            const settingsDiv = document.getElementById('auto-update-settings');
            if (e.target.checked) {
                settingsDiv.classList.remove('hidden');
            } else {
                settingsDiv.classList.add('hidden');
            }
        });
        
        // Afficher/masquer le champ de code secret
        document.getElementById('events-type').addEventListener('change', (e) => {
            const secretCodeField = document.getElementById('secret-code-field');
            if (e.target.value === 'secret_code') {
                secretCodeField.classList.remove('hidden');
            } else {
                secretCodeField.classList.add('hidden');
            }
        });
        
        // Fonction pour afficher un message
        function showMessage(elementId, message, type) {
            const messageElement = document.getElementById(elementId);
            messageElement.textContent = message;
            messageElement.classList.remove('hidden', 'alert-success', 'alert-error');
            messageElement.classList.add(`alert-${type}`);
        }
        
        // Fonction pour ajouter un événement à l'historique
        function addEventToHistory(type, title, description) {
            const historyElement = document.getElementById('events-history');
            
            // Supprimer le message "Aucun événement"
            if (historyElement.querySelector('p')) {
                historyElement.innerHTML = '';
            }
            
            const eventElement = document.createElement('div');
            eventElement.className = 'p-3 bg-gray-800 rounded-lg border border-gray-700';
            
            const eventHeader = document.createElement('div');
            eventHeader.className = 'flex justify-between items-start';
            
            const eventTitle = document.createElement('h4');
            eventTitle.className = 'font-medium text-purple-400';
            eventTitle.textContent = title;
            
            const eventType = document.createElement('span');
            eventType.className = 'text-xs bg-purple-900/30 text-purple-300 px-2 py-1 rounded';
            eventType.textContent = type;
            
            eventHeader.appendChild(eventTitle);
            eventHeader.appendChild(eventType);
            
            const eventDescription = document.createElement('p');
            eventDescription.className = 'text-sm text-gray-400 mt-2';
            eventDescription.textContent = description;
            
            const eventTime = document.createElement('p');
            eventTime.className = 'text-xs text-gray-500 mt-2';
            eventTime.textContent = `Envoyé le ${new Date().toLocaleString()}`;
            
            eventElement.appendChild(eventHeader);
            eventElement.appendChild(eventDescription);
            eventElement.appendChild(eventTime);
            
            historyElement.prepend(eventElement);
        }
        
        // Charger des données initiales lors du chargement de la page
        document.addEventListener('DOMContentLoaded', async () => {
            // Charger les métadonnées pour un exemple
            try {
                const response = await fetch('/api/metadata/0');
                if (response.ok) {
                    const metadata = await response.json();
                    
                    document.getElementById('metadata-name').value = metadata.name || '';
                    document.getElementById('metadata-description').value = metadata.description || '';
                    document.getElementById('metadata-image').value = metadata.image || '';
                    
                    if (metadata.attributes && metadata.attributes.length > 0) {
                        document.getElementById('metadata-attributes').value = JSON.stringify(metadata.attributes, null, 2);
                    }
                }
            } catch (error) {
                console.error('Erreur lors du chargement des métadonnées:', error);
            }
        });
    </script>
</body>
</html>